#!/bin/bash
set -e

ERRORS=0

if [ -d nubis/puppet ]; then
    echo "Running Puppet Lint"
    puppet-lint \
        --no-puppet_url_without_modules-check \
        --no-80chars-check \
        --no-140chars-check \
        --fail-on-warnings nubis/puppet/*pp \
        || echo -e "\033[1;31mWARNING: Puppet linting will be enforced soon. Please fix these issues.\033[0m" #ERRORS=$(( ERRORS + 1 ))
fi

echo "Running ShellCheck"
find -path "./.git*" -prune \
    -o -path ./nubis/travis -prune \
    -o -path ./nubis/librarian-puppet -prune \
    -o -path ./nubis/.tmp -prune \
    -o -type f -a \! \
    -name '*.tmpl' -print0 \
    | xargs -0 file \
    | grep 'shell script' \
    | cut -d: -f1 \
    | xargs -r shellcheck \
    || ERRORS=$(( ERRORS + 1 ))

echo "Running JSON Lint"
find  -not \( \( \
    -path ./nubis/librarian-puppet \
    -o -path ./nubis/.tmp \
    -o -path ./nubis/travis \)  \
    -prune \) \
    -type f \
    -name '*.json*' -print0 \
    | xargs -r0 jsonlint \
    || ERRORS=$(( ERRORS + 1 ))

echo "Running MarkDown Lint"
find  -not \( \( \
    -path ./nubis/librarian-puppet \
    -o -path ./nubis/.tmp \
    -o -path ./nubis/travis \)  \
    -prune \) \
    -type f \
    -name \*.md \
    | grep -v ./CHANGELOG.md \
    | xargs -r mdl --style /nubis/style.rb \
    || ERRORS=$(( ERRORS + 1 ))

exit $ERRORS
